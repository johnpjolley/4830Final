<!--https://console.firebase.google.com/project/cs4830final-cd342/overview-->
<!DOCTYPE html>
<html>
    <head>
        <title>Blog</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
        <script src="js/mustache.js"></script>
        <script>
        // Initialize Firebase
        var config = 
        {
            apiKey: "AIzaSyByPvg1_iTX2XGxIJ7URgrKKmqCU-pL4lQ",
            authDomain: "cs4830final-cd342.firebaseapp.com",
            databaseURL: "https://cs4830final-cd342.firebaseio.com",
            projectId: "cs4830final-cd342",
            storageBucket: "cs4830final-cd342.appspot.com",
            messagingSenderId: "27905852925"
        };
        firebase.initializeApp(config);
        </script>
        <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
        
        <!-- Bootstrap core CSS -->
        <link href="startbootstrap-simple-sidebar-gh-pages/startbootstrap-simple-sidebar-gh-pages/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <!-- Bootstrap core JavaScript -->
        <script src="startbootstrap-simple-sidebar-gh-pages/startbootstrap-simple-sidebar-gh-pages/vendor/jquery/jquery.min.js"></script>
        <script src="startbootstrap-simple-sidebar-gh-pages/startbootstrap-simple-sidebar-gh-pages/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        
        <link rel="stylesheet" type="text/css" href="ThreadPage.css">
    </head>
    <body onload="getBlog()">
        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
        
        <script>
        // Initialize Firebase
        var config = 
        {
            apiKey: "AIzaSyByPvg1_iTX2XGxIJ7URgrKKmqCU-pL4lQ",
            authDomain: "cs4830final-cd342.firebaseapp.com",
            databaseURL: "https://cs4830final-cd342.firebaseio.com",
            projectId: "cs4830final-cd342",
            storageBucket: "cs4830final-cd342.appspot.com",
            messagingSenderId: "27905852925"
        };
        firebase.initializeApp(config);
        </script>
        
        <div id="display"></div>
        <div id="displayComments"></div>
        
        <script id="template" type="x-tmpl-mustache">
            <div id="blog">
                <a class="return" href="index.html">Back</a>
                <h1 class="blogTitle">{{blogName}}</h1>
                <p class="posterInfo">Posted by {{blogger}}</p>
                <p class="posterInfo">Posted on {{date}}</p>
                <p>{{content}}</p>
            </div>
            <br>
            {{#loggedIn}}
                <h2 id="comments">Comments</h2>
                <h4>You are logged in as: {{userName}}</h4>
                <textarea id="newComment" placeholder="Enter Your Comment Here"></textarea><br>
                <button id="submit" class="btn btn-primary" onclick="postComment()">Post Comment</button>
            <br>
            {{/loggedIn}}
            {{#comments}}
                <div class="comment">
                    <p class="commenterID">{{commenter}}</p>
                    <p class="date">{{postDate}}</p>
                    <p>{{message}}</p>
                </div>
            {{/comments}}
        </script>
        
        <script>
            
            //This is dummy data that I put in for demonstration purposes. In reality, the user will select a blog on the main page to view, at which point the user is directed to the ThreadPage where the requisite information (which may be slightly different from what is here) for the selected blog is pulled from the database and displayed.
            function assign(loggedIn, blogName, userName, date, content,  comments, blogKey) 
            {
                if( comments !== null)
                {
                    var ref = firebase.database().ref('blogs/' +blogKey);
                    var commentList = [];

                    ref.child('comments').orderByChild('commenter').on('child_added', snap =>
                    {
                        console.log(snap.val());
                        var commenter = snap.val().commenter;
                        var postDate = snap.val().postDate;
                        var message = snap.val().message;
                        var specificComment = {commenter: commenter, postDate: postDate, message: message};
//                        JSON.stringify(specificComment);
                        commentList.push(specificComment);
                        //console.log(specificComment);
                        console.log(commentList);
                    });
                }
                
                
                var blogPost = 
                {
                    loggedIn: loggedIn,
                    blogName: blogName,
                    blogger: userName,
                    date: date,
                    content: content,
                    userName: "User X",
                    comments: commentList
//                    [
//                        {
//                            commenter: "User 1",
//                            postDate: "November 26, 2017",
//                            postTime: "11:00 PM",
//                            message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed vel bibendum tellus, sit amet convallis lectus. Curabitur mi turpis, suscipit id quam feugiat, porta lobortis arcu. Aenean et varius augue. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos."
//                        },
//                        {
//                            commenter: "User 2",
//                            postDate: "November 26, 2017",
//                            postTime: "11:10 PM",
//                            message: "Etiam quis enim vel ipsum suscipit mollis. Nulla laoreet arcu vitae condimentum pellentesque. Cras feugiat orci in tincidunt varius. Mauris quis magn ultricies, porta odio quis, varius arcu."
//                        },
//                        {
//                            commenter: "User 3",
//                            postDate: "November 26, 2017",
//                            postTime: "11:20 PM",
//                            message: "Sed eget egestas quam. Donec a vehicula elit, in auctor neque. Sed ultrices vulputate mauris, at gravida dui malesuada at. Phasellus dapibus efficitur lobortis. Praesent eget sapien ultricies, ultrices mauris vitae, tristique ligula. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Mauris eu erat enim. Fusce vulputate scelerisque risus eu vehicula."
//                        },
//                    ],
                }
                //console.dir(blogPost.comments);
                var template = document.getElementById("template");
                var hash = blogPost;
        
                var output = Mustache.render(template.innerHTML, hash);
        
                var display = document.getElementById("display");
                display.innerHTML = output;
            }
            function getBlog()
            {
                var blogList = this;
                var retrievedData = localStorage.getItem('theBlogs');
                var blogInfo = JSON.parse(retrievedData);
                var size = blogInfo.length;
//                console.dir(blogInfo);
//                console.log(size);
                
                for (var i = 0; i < size; i++)
                {
                    var specificBlog = blogInfo[i];
                    //console.dir(specificBlog);
                    var verdict = specificBlog.selected;
                    //console.log(verdict);
                    if(verdict === true)
                    {
                        var blog = blogInfo[i];
                        //console.dir(blog);
                    }
                }
                var blogKey = blog.key;
                //console.dir(blogKey);
                
                //Useful Resource: https://firebase.google.com/docs/reference/js/firebase.database.DataSnapshot
                var ref = firebase.database().ref('blogs/' +blogKey);
                ref.once("value")
                    .then(function(snapshot) 
                    {
                        var key = snapshot.val();
                        //console.log(key);
                        var blogName = snapshot.child("blogName").val();
                        //console.log(blogName);
                        var content = snapshot.child("content").val();
                        //console.log(content);
                        var date = snapshot.child("date").val();
                        //console.log(date);
                        var loggedIn = true;
                        var userName = "test@test.com";
                        var comments = snapshot.child('comments').val();
                        //console.dir(comments);
                        assign(loggedIn, blogName, userName, date, content,  comments, blogKey);
                    });
            }
            
            function postComment()
            {
//                var postedComment = document.getElementById('newComment');
                var user = "User X";
                
                //get the current date
                var dt = new Date();    
                var month = dt.getMonth()+1;  
                var day = dt.getDate();  
                var year = dt.getFullYear();  
                var date = (month + '-' + day + '-' + year);
                
                //retrieve the key for this blog
                var blogList = this;
                var retrievedData = localStorage.getItem('theBlogs');
                var blogInfo = JSON.parse(retrievedData);
                var size = blogInfo.length;
//                console.dir(blogInfo);
//                console.log(size);
                
                for (var i = 0; i < size; i++)
                {
                    var specificBlog = blogInfo[i];
                    //console.dir(specificBlog);
                    var verdict = specificBlog.selected;
                    //console.log(verdict);
                    if(verdict === true)
                    {
                        var blog = blogInfo[i];
                        //console.dir(blog);
                    }
                }
                var blogKey = blog.key;
                //console.dir(blogKey);
                
                var blogs = firebase.database().ref().child('blogs/' +blogKey);
                var comments = blogs.child('comments');

                var newPost = comments.push(
                {
                    commenter: user,
                    postDate: date,
                    message: $('#newComment').val()
                });
                var postID = newPost.key;
                //console.log(postID);
                getBlog();
            }
        </script>
    </body>
</html>
